# MBTA Bus Delay Predictor — Random Forest Pipeline

This README documents how to build, run, and reproduce the random-forest results in this repo. It focuses on the CLI trainer `train_rf_bus.py` and its artifacts.

## Quickstart

```bash
# 1) Create venv and install deps
make -f Makefile_rf install

# 2) Rebuild processed cache (first time only or when CSV changes)
make -f Makefile_rf cache CSV=mbta_bus.csv OUT=artifacts

# 3) Train (uses cache if fresh)
make -f Makefile_rf train CSV=mbta_bus.csv OUT=artifacts N_ESTIMATORS=100 MAX_DEPTH=14 MAX_SAMPLES=0.3
```

Artifacts land in `artifacts/`: `metrics.txt`, `confusion_matrix.png`, `feature_importance.csv`, `model.joblib`, `training_summary.json`, and `cache/processed.parquet`.

## Inference (use the saved model)

```bash
# Score new data with the trained pipeline
python predict_rf.py --model artifacts/model.joblib --input new_data.csv --output preds.csv --threshold 0.5
```

`predict_rf.py` expects the feature columns used in training. It outputs `pred_proba_delayed` and `pred_label` (0/1).

## Data & Splits
- Input CSV (expected): `mbta_bus.csv` with columns like `service_date`, `route_id`, `stop_id`, `direction_id`, `point_type`, `delay_seconds`, and weather fields.
- Label handling: invalid/missing `delay_seconds` are dropped; remaining delays are clipped to ±2 hours; labels are binary (delayed vs not_delayed) using ±300s tolerance.
- Splits: train = 2023-01-01 to 2023-09-30, val = 2023-10-01 to 2023-12-31, test = 2024-01-01 to 2024-12-31.
- Class balance (latest run): train ~32% delayed, val ~35% delayed, test ~34% delayed (see `training_summary.json`).

## Feature Engineering & Encoding
- Calendar: month, day_of_year, season, `is_holiday`, `is_school_in_session`.
- Time/sequence: hour, weekday, is_weekend, time_point_order, rainy_rush_hour.
- Weather: air_temp_c, rel_humidity_pct, precip_mm, wind_dir_deg, wind_speed_kmh, pressure_hpa, cloud_cover.
- Categorical handling: target encoding for `route_id` and `stop_id`; ordinal encoding for `direction_id`, `point_type`, `weather_condition`, `season`; rare stops bucketed via `--top_stops` (default 300).
- Numerics are stored as float32 in the cache to reduce memory.

## Model & Hyperparameters
- Model: `RandomForestClassifier` with class_weight balanced.
- Defaults: `n_estimators=100`, `max_depth=14`, `min_samples_leaf=25`, `max_features=log2`, `max_samples=0.3` (row subsampling per tree), `random_state=42`, `top_stops=300`.
- Two-stage flow: fit on train → eval on val; refit on train+val → eval on test.

## Results (latest run)
- Validation: PR-AUC 0.5870, ROC-AUC 0.7228, precision/recall (delayed) = 0.50/0.71.
- Test: PR-AUC 0.4857, ROC-AUC 0.6668, precision/recall (delayed) = 0.4693/0.5988, accuracy 0.6278.
- Training time: ~16 minutes total (stage1 ~2.9 min, stage2 ~13.1 min).
- Top importances: time_point_order, hour, route_id, point_type, day_of_year, stop_id.
- See `artifacts/metrics.txt` and `artifacts/training_summary.json` for full reports.

## Reproducing
- Ensure the CSV path is correct (`CSV=...`).
- Rebuild cache after raw CSV changes or feature changes: `make -f Makefile_rf cache`.
- Train: `make -f Makefile_rf train` (override hyperparams via env vars).
- Memory tips (16 GB): keep `MAX_SAMPLES` ≤ 0.3, `TOP_STOPS` around 300, and use float32 (already enabled).

## Visualizations
- Feature importances: `artifacts/feature_importance.csv` and `artifacts/feature_importance.png` (run `python visualize_rf.py --out_dir artifacts` to regenerate).
- Confusion matrices: `artifacts/confusion_matrix.png` (test). Validation matrix is generated during training as `confusion_matrix_val.png`.
- Metric summaries: `artifacts/metrics.txt` (full reports) and `artifacts/roc_pr_summary.txt` (generated by `visualize_rf.py`).

## Testing & CI
- `make -f Makefile_rf test` checks for presence of `training_summary.json` after training (simple smoke test).
- Add a GitHub Actions workflow to run `make -f Makefile_rf train` on a small sample or to run the smoke test.

## Environment
- Python 3.10+ recommended.
- Tested on macOS (M1, 16 GB). Dependencies in `requirements_RF.txt` (includes `category_encoders`, `holidays`, `pyarrow`).

## Contributing
- Open issues/PRs for bugs or enhancements.
- Keep artifacts under `artifacts/`; use `--out_dir` to direct outputs elsewhere if needed.
